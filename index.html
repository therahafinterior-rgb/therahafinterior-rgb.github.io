<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Interior Design — Proposal & Quote</title>
<style>
  :root{ --bg:#fffdf5; --card:#f5eee6; --ink:#1f2328; --muted:#5f4e52; --line:#eadede; --accent:#c6939f; --accent-ink:#ffffff; }
  [data-theme="classic"]{ --bg:#fffdf5; --card:#f5eee6; --ink:#1f2328; --muted:#5f4e52; --line:#eadede; --accent:#c6939f; --accent-ink:#ffffff; }
  [data-theme="sand"]{ --bg:#fffcf6; --card:#f3e8de; --ink:#2a2418; --muted:#6a5b3b; --line:#e8d8c7; --accent:#b79a83; --accent-ink:#ffffff; }
  [data-theme="sea"]{ --bg:#f0faf7; --card:#e6f2ef; --ink:#0f172a; --muted:#334155; --line:#cfe4df; --accent:#6fa1aa; --accent-ink:#ffffff; }

  html,body{ height:100%; }
  body{ font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--ink); margin:0; font-weight:500; font-size:13.25px; line-height:1.35; }
  *{ box-sizing:border-box; }

  header{ display:grid; grid-template-columns: auto 1fr auto; align-items:center; gap:12px; padding:10px 14px; border-bottom:1px solid var(--line); position:sticky; top:0; background:var(--bg); z-index:5; }
  .logo{ width:240px; height:72px; display:grid; place-items:center; }
  .logo img{ max-width:240px; max-height:72px; object-fit:contain; }
  .title{ text-align:center; font-weight:700; font-size:20px; letter-spacing:.2px; }
  .header-actions{ display:flex; gap:8px; align-items:center; }
  select, input[type="date"], input[type="text"], input[type="email"], input[type="number"]{ border:1px solid var(--line); background:#fff; color:var(--ink); border-radius:6px; padding:6px 8px; font-size:13px; height:32px; }
  button{ border:1px solid var(--line); background:var(--accent); color:var(--accent-ink); border-radius:8px; padding:6px 10px; font-weight:600; cursor:pointer; height:30px; }
  button.secondary{ background:#fff; color:var(--ink); }

  .page{ padding:10px 12px; display:grid; grid-template-rows: auto 1fr; gap:10px; }

  .client{ background:var(--card); border:1px solid var(--line); border-radius:10px; padding:10px; }
  .client h3{ margin:0 0 8px 0; font-size:14px; }
  .grid-8{ display:grid; grid-template-columns: repeat(8, 1fr); gap:8px; }
  .grid-8 .field{ display:flex; flex-direction:column; gap:4px; }
  label{ font-size:11.5px; color:var(--muted); }
  .req{ color:#dc2626; }
  .warn{ color:#b45309; font-size:11px; margin-top:6px; display:none; }
  .note{ color:var(--muted); font-size:11px; margin-top:6px; }

  main.main{ display:grid; grid-template-columns: 1.4fr 1fr; gap:10px; }

  .card{ background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .card h3{ margin:0 0 8px 0; font-size:14px; }

  table{ width:100%; border-collapse:collapse; font-size:12.5px; }
  th, td{ border-bottom:1px solid var(--line); padding:6px 4px; text-align:right; }
  th{ font-size:11.5px; color:var(--muted); font-weight:600; }
  td:first-child, th:first-child{ text-align:left; }
  tfoot td{ border-top:1px solid var(--line); font-weight:700; }
  .qty{ width:56px; }
  .num{ font-variant-numeric: tabular-nums; }
  .muted{ color:var(--muted); font-size:11px; }
  .pill{ display:inline-block; padding:2px 6px; border-radius:999px; background:var(--card); border:1px solid var(--line); font-size:10.5px; color:var(--muted); }
  .pill.active{ background:var(--accent); color:var(--accent-ink); border-color:var(--accent); }

  .totals{ display:grid; gap:6px; }
  .totals .row{ display:flex; justify-content:space-between; align-items:center; font-size:13.25px; }
  .totals .row strong{ font-size:14.25px; }
  .totals .hr{ height:1px; background:var(--line); margin:2px 0; }

  .quick{ background:var(--card); border:1px dashed var(--line); border-radius:10px; padding:10px; display:grid; gap:6px; }
  .quick .line{ display:flex; justify-content:space-between; font-size:12.5px; }
  .save.good{ color:#047857; }
  .save.bad{ color:#b91c1c; }

  .timeline .phase{ display:flex; justify-content:space-between; font-size:12.5px; padding:4px 0; border-bottom:1px dashed var(--line); }
  .timeline .phase:last-child{ border-bottom:0; }
  .timeline small{ color:var(--muted); }

  .admin{ background:#fff7fb; border-color:#f5d0fe; }
  .admin .hint{ font-size:11px; color:#6b21a8; }

  footer{ display:flex; gap:14px; justify-content:space-between; align-items:center; font-size:11px; color:var(--muted); margin-top:6px; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  @page{ size: A4 landscape; margin: 10mm; }
  @media print{
    header{ position:static; }
    .header-actions .no-print{ display:none !important; }
    .page{ padding:0; }
    body{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    button, select, input{ -webkit-appearance:none; appearance:none; }
    #adminPanel{ display:none !important; }
  }
</style>
</head>
<body data-theme="classic">
  <header>
    <div class="logo"><img alt="Logo" src="data:image/png;base64,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"></div>
    <div class="title">Interior Design — Proposal & Quote</div>
    <div class="header-actions">
      <label for="theme" class="muted">Theme</label>
      <select id="theme" aria-label="Theme">
        <option value="classic">Classic</option>
        <option value="sand">Sand</option>
        <option value="sea">Sea</option>
      </select>
      <button id="printBtn" title="Print / Save PDF">Print / PDF</button>
      <button id="clearBtn" class="secondary" title="Reset custom & switch to Custom">Clear custom qty</button>
    </div>
  </header>

  <div class="page">
    <section class="client card">
      <h3>Client & Project</h3>
      <div class="grid-8">
        <div class="field"><label>Client<span class="req">*</span></label><input id="f_client" type="text" required></div>
        <div class="field"><label>National ID<span class="req">*</span></label><input id="f_id" type="text" required></div>
        <div class="field"><label>Phone (Saudi)<span class="req">*</span></label><input id="f_phone" type="text" inputmode="numeric" pattern="^(05\d{8}|\+?9665\d{8})$" title="Saudi: 05XXXXXXXX or +9665XXXXXXXX" required></div>
        <div class="field"><label>Email<span class="req">*</span></label><input id="f_email" type="email" required></div>
        <div class="field"><label>Project</label><input id="f_project" type="text"></div>
        <div class="field"><label>Start (date)<span class="req">*</span></label><input id="f_start" type="date" required></div>
        <div class="field"><label>Package<span class="req">*</span></label>
          <select id="f_package">
            <option>Custom</option>
            <option>Package 1</option>
            <option>Package 2</option>
            <option>Package 3</option>
            <option>Package 4</option>
          </select>
        </div>
        <div class="field"><label>Rooms<span class="req" id="roomsStar">*</span></label><input id="f_rooms" type="number" min="0" value="0"></div>
        <div class="field"><label>Area m²</label><input id="f_area" type="number" min="0" value="0"></div>
      </div>
      <div id="capWarn" class="warn">Heads‑up: Selected package coverage exceeded. Extra rooms/area will be priced A la carte.</div>
      <div class="note">We will rely on notes and approvals from this phone/email only. Timeline starts after payment/data handover. Extra revisions extend the delivery time. <strong>Quote is valid for 14 days.</strong> This invoice becomes binding upon both parties' signatures.</div>
    </section>

    <section id="adminPanel" class="card admin" style="display:none;">
      <h3>Admin — Special Discount</h3>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <label><input type="radio" name="sd_mode" value="pct" checked> Percent (%)</label>
        <label><input type="radio" name="sd_mode" value="sar"> Fixed (SAR)</label>
        <input id="sd_value" type="number" min="0" value="0" style="width:120px;" />
        <input id="sd_note" type="text" placeholder="Note (optional)" style="flex:1; min-width:200px;" />
        <button id="sd_apply">Apply</button>
        <button id="sd_clear" class="secondary">Clear</button>
        <button id="sd_copy" class="secondary" title="Copy link with discount encoded">Copy client link</button>
      </div>
      <div class="hint">Unlock admin with <kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>A</kbd> or append <code>#admin</code> to the URL. Default PIN: <code>2468</code>. To lock for clients, share the URL that includes <code>?lock=1&sdpct=10</code> or <code>?sdsar=500</code> (generated by “Copy client link”).</div>
    </section>

    <main class="main">
      <section class="card">
        <h3>Design Services</h3>
        <table id="services">
          <thead>
            <tr>
              <th>Service</th>
              <th>Unit SAR</th>
              <th>Auto Qty</th>
              <th>Custom Qty</th>
              <th>ALL plan</th>
              <th>Final Qty</th>
              <th>Line Total</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="customAllSummary" class="note" style="display:none"></div>

        <h3 style="margin-top:10px;">Add‑ons</h3>
        <table id="addons">
          <thead>
            <tr>
              <th>Add‑on</th>
              <th>Unit SAR</th>
              <th>Qty</th>
              <th>Line Total</th>
            </tr>
          </thead>
          <tbody>
            <tr data-addon="siteVisit"><td>Site supervision — per visit</td><td class="num">600</td><td><input class="qty" type="number" min="0" value="0"></td><td class="num line">0</td></tr>
            <tr data-addon="sitePack"><td>Site supervision — 5‑visit pack</td><td class="num">2500</td><td><input class="qty" type="number" min="0" value="0"></td><td class="num line">0</td></tr>
            <tr data-addon="onSite"><td>On‑site consultation (session)</td><td class="num">450</td><td><input class="qty" type="number" min="0" value="0"></td><td class="num line">0</td></tr>
            <tr data-addon="online"><td>Online consultation (session)</td><td class="num">350</td><td><input class="qty" type="number" min="0" value="0"></td><td class="num line">0</td></tr>
            <tr data-addon="boq"><td>BOQ — per room <span class="muted">(1–3 rooms @750, 4+ @650)</span></td><td class="num">tiered</td><td><input id="boqRooms" class="qty" type="number" min="0" value="0"></td><td class="num line">0</td></tr>
            <tr data-addon="revision"><td>Extra revision (round)</td><td class="num">250</td><td><input class="qty" type="number" min="0" value="0"></td><td class="num line">0</td></tr>
            <tr data-addon="shopping"><td>Shopping day / sourcing (per day)</td><td class="num">500</td><td><input class="qty" type="number" min="0" value="0"></td><td class="num line">0</td></tr>
            <tr data-addon="rush"><td>Rush (P1–P2 only) <span class="muted">+20% of design total</span></td><td class="num">—</td><td><input id="rushToggle" type="checkbox"></td><td class="num line" id="rushFee">0</td></tr>
          </tbody>
        </table>
      </section>

      <section class="card">
        <h3>Quick Math</h3>
        <div class="quick" id="quick">
          <div class="line"><span>A la carte total (no discount)</span><strong class="num" id="qm_alc">0</strong></div>
          <div class="line"><span>Package price</span><strong class="num" id="qm_pkg">0</strong></div>
          <div class="line"><span>You save</span><strong class="num save" id="qm_save">0</strong></div>
        </div>

        <h3 style="margin-top:10px;">Totals</h3>
        <div class="totals">
          <div class="row"><span>Subtotal (design)</span><strong class="num" id="t_sub">0</strong></div>
          <div class="row"><span>Package discount</span><strong class="num" id="t_disc">0</strong></div>
          <div class="row"><span>Special discount (manual)</span><strong class="num" id="t_special">0</strong></div>
          <div class="row"><span>Design total</span><strong class="num" id="t_design">0</strong></div>
          <div class="row"><span>Rush fee</span><strong class="num" id="t_rush">0</strong></div>
          <div class="row"><span>Add‑ons subtotal</span><strong class="num" id="t_addons">0</strong></div>
          <div class="hr"></div>
          <div class="row"><span><strong>Grand total</strong></span><strong class="num" id="t_grand">0</strong></div>
          <div class="muted" id="sd_note_view" style="display:none;"></div>
        </div>

        <h3 style="margin-top:10px;">Timeline</h3>
        <div class="note" id="pkgOverview">Package durations: P1 ≈ 15 wd (Rush ≈ 11) • P2 ≈ 22 wd (Rush ≈ 17) • P3 ≈ 32 wd • P4 ≈ 45 wd.</div>
        <div class="timeline" id="timeline"></div>
        <div class="note" style="margin-top:6px;">Shop drawings exclude carpentry scope. BOQ time (<span class="mono" id="boqLead">4–5</span> working days) is added separately to the work schedule.</div>
      </section>
    </main>

    <footer>
      <div>Prepared by: <span class="mono" id="footClient">—</span> | Project: <span class="mono" id="footProject">—</span></div>
      <div class="muted">Generated by: One‑Page Quote Calculator — A4 Landscape — MASTER v1.2 (Admin Discount)</div>
    </footer>
  </div>

<script>
(function(){
  const fmt = n => new Intl.NumberFormat('en-US',{maximumFractionDigits:0}).format(Math.round(n||0));
  const byId = id => document.getElementById(id);
  const q = new URLSearchParams(window.location.search);

  // Admin unlock settings
  const ADMIN_PIN = "2468";  // change if you like
  const hasAdminHash = window.location.hash.toLowerCase().includes('admin');
  const lockedForClient = q.get('lock') === '1';

  // Special discount input from URL params (sdpct or sdsar)
  let sd_mode = q.has('sdsar') ? 'sar' : (q.has('sdpct') ? 'pct' : 'pct');
  let sd_value = q.has('sdsar') ? Math.max(0, +q.get('sdsar')||0) : Math.max(0, +q.get('sdpct')||0);
  let sd_note  = q.get('sdnote') || '';

  // Services
  const SERVICES = [
    {key:'d3', name:'3D (per space)', unit:1605},
    {key:'mood', name:'Mood board (per space)', unit:300},
    {key:'furniture', name:'Furniture plan', unit:840},
    {key:'rc', name:'RC plans', unit:600},
    {key:'flooring', name:'Flooring plan', unit:420},
    {key:'lighting', name:'Lighting plan', unit:840},
    {key:'materials', name:'Material selections', unit:600},
    {key:'execution', name:'Shop drawings (no carpentry)', unit:1100},
    {key:'elev', name:'Room elevations (per room)', unit:900}
  ];
  const ELIGIBLE = new Set(['furniture','rc','flooring','lighting']);

  const PACKS = {
    'Custom': { label:'Custom', disc:0, capRooms:Infinity, capArea:Infinity, rush:false,
      auto:{ d3:0, mood:0, furniture:0, rc:0, flooring:0, lighting:0, materials:0, execution:0, elev:0 },
      allPlan: new Set(), timeline:'custom' },
    'Package 1': { label:'Package 1', disc:0.15, capRooms:3, capArea:90, rush:true,
      auto:{ d3:0, mood:2, furniture:1, rc:1, flooring:1, lighting:1, materials:1, execution:1, elev:2 },
      allPlan: new Set(), timeline:'p1' },
    'Package 2': { label:'Package 2', disc:0.12, capRooms:4, capArea:120, rush:true,
      auto:{ d3:2, mood:0, furniture:1, rc:1, flooring:1, lighting:1, materials:1, execution:1, elev:2 },
      allPlan: new Set(), timeline:'p2' },
    'Package 3': { label:'Package 3', disc:0.14, capRooms:4, capArea:180, rush:false,
      auto:{ d3:3, mood:3, furniture:1, rc:1, flooring:1, lighting:1, materials:1, execution:1, elev:3 },
      allPlan: new Set(['furniture','flooring']), timeline:'p3' },
    'Package 4': { label:'Package 4', disc:0.16, capRooms:6, capArea:240, rush:false,
      auto:{ d3:5, mood:3, furniture:1, rc:1, flooring:1, lighting:1, materials:1, execution:1, elev:5 },
      allPlan: new Set(['furniture','rc','flooring','lighting']), timeline:'p4' }
  };

  // Build Services table
  const servicesTbody = document.querySelector('#services tbody');
  SERVICES.forEach(s => {
    const tr = document.createElement('tr');
    tr.dataset.service = s.key;
    const pill = ELIGIBLE.has(s.key) ? '<span class="pill allpill" data-key="'+s.key+'">ALL plan eligible</span>' : '';
    const allCtl = ELIGIBLE.has(s.key) ? '<input type="checkbox" class="allbox" disabled>' : '—';
    tr.innerHTML = `
      <td>${s.name} ${pill}</td>
      <td class="num unit">${fmt(s.unit)}</td>
      <td class="num auto">0</td>
      <td><input class="qty custom" type="number" min="0" value="0"></td>
      <td class="allcol" style="text-align:center;">${allCtl}</td>
      <td class="num final">0</td>
      <td class="num line">0</td>
    `;
    servicesTbody.appendChild(tr);
  });

  // Elements
  const pkgSel = byId('f_package');
  const roomsInp = byId('f_rooms');
  const areaInp = byId('f_area');
  const rushToggle = byId('rushToggle');
  const boqRooms = byId('boqRooms');

  // Totals elements
  const elSub = byId('t_sub');
  const elDisc = byId('t_disc');
  const elSpecial = byId('t_special');
  const elDesign = byId('t_design');
  const elRush = byId('t_rush');
  const elAddons = byId('t_addons');
  const elGrand = byId('t_grand');
  const elQuickAlc = byId('qm_alc');
  const elQuickPkg = byId('qm_pkg');
  const elQuickSave = byId('qm_save');
  const elCapWarn = byId('capWarn');
  const elBoqLead = byId('boqLead');
  const footClient = byId('footClient');
  const footProject = byId('footProject');
  const customAllSummary = byId('customAllSummary');
  const sdNoteView = byId('sd_note_view');

  // Admin DOM
  const adminPanel = byId('adminPanel');
  const sdValEl = byId('sd_value');
  const sdNoteEl = byId('sd_note');
  const sdApplyBtn = byId('sd_apply');
  const sdClearBtn = byId('sd_clear');
  const sdCopyBtn = byId('sd_copy');

  let customAll = new Set(); // for Custom mode only

  function getCurrentPack(){ return PACKS[pkgSel.value] || PACKS['Custom']; }
  function packIsAll(key){ const pack = getCurrentPack(); return pack.allPlan.has(key); }
  function customIsAll(key){ return customAll.has(key); }

  function updatePillsAndBoxes(){
    const isCustom = pkgSel.value==='Custom';
    document.querySelectorAll('#services tbody tr').forEach(tr=>{
      const key = tr.dataset.service;
      const pill = tr.querySelector('.allpill');
      const box = tr.querySelector('.allbox');
      if(pill){
        const active = isCustom ? customIsAll(key) : packIsAll(key);
        pill.textContent = active ? 'ALL plan (active)' : 'ALL plan eligible';
        pill.classList.toggle('active', active);
      }
      if(box){ box.disabled = !isCustom; box.checked = isCustom ? customIsAll(key) : false; }
    });
    if(pkgSel.value==='Custom'){
      const names = Array.from(customAll).map(k=> SERVICES.find(s=>s.key===k)?.name.split(' ')[0]).filter(Boolean);
      if(names.length){ customAllSummary.style.display='block'; customAllSummary.textContent = 'ALL plan active (Custom): ' + names.join(', '); }
      else { customAllSummary.style.display='none'; customAllSummary.textContent=''; }
    } else { customAllSummary.style.display='none'; customAllSummary.textContent=''; }
  }

  function updateCapWarning(){
    const pack = getCurrentPack();
    const rooms = +roomsInp.value||0; const area = +areaInp.value||0;
    const exceeded = (rooms>pack.capRooms) || (area>pack.capArea);
    elCapWarn.style.display = exceeded && pkgSel.value!=='Custom' ? 'block':'none';
  }

  function setAutoQtyByPack(){
    const pack = getCurrentPack();
    document.querySelectorAll('#services tbody tr').forEach(tr=>{
      const key = tr.dataset.service;
      const autoQty = pack.auto[key] ?? 0;
      tr.querySelector('.auto').textContent = autoQty;
      const customField = tr.querySelector('input.custom');
      const finalCell = tr.querySelector('.final');
      if(pkgSel.value==='Custom'){
        customField.removeAttribute('disabled');
        finalCell.textContent = +customField.value||0;
      }else{
        customField.value = 0;
        customField.setAttribute('disabled','disabled');
        finalCell.textContent = autoQty;
      }
    });
    const p = pkgSel.value;
    if(PACKS[p].rush){ rushToggle.removeAttribute('disabled'); }
    else { rushToggle.checked=false; rushToggle.setAttribute('disabled','disabled'); }

    const roomsStar = document.getElementById('roomsStar');
    if(p === 'Custom'){ roomsInp.setAttribute('required','required'); if(roomsStar) roomsStar.style.display='inline'; }
    else { roomsInp.removeAttribute('required'); if(roomsStar) roomsStar.style.display='none'; }
  }

  function computeDesignLines(){
    let subtotal = 0;
    let quickAlc = 0;
    const isCustom = pkgSel.value==='Custom';

    document.querySelectorAll('#services tbody tr').forEach(tr=>{
      const key = tr.dataset.service;
      const unitBase = SERVICES.find(s=>s.key===key).unit;
      const autoQty = +(tr.querySelector('.auto').textContent||0);
      const customQty = +(tr.querySelector('input.custom').value||0);
      const finalQty = isCustom ? customQty : autoQty;
      tr.querySelector('.final').textContent = finalQty;

      const eligible = ELIGIBLE.has(key);
      const activeAll = eligible && ( isCustom ? customIsAll(key) : packIsAll(key) );
      const unitAdj = Math.round(unitBase * (activeAll?1.5:1));
      tr.querySelector('.unit').textContent = fmt(unitAdj);

      const line = unitAdj * finalQty;
      tr.querySelector('.line').textContent = fmt(line);
      subtotal += line; quickAlc += line;
    });

    const pack = getCurrentPack();
    const discount = Math.round(subtotal * pack.disc);
    let designBase = subtotal - discount;
    if(pkgSel.value==='Package 1' && designBase < 6500){ designBase = 6500; }

    // Special discount (admin)
    let special = 0;
    if(sd_value>0){ special = sd_mode==='pct' ? Math.round(designBase * (Math.min(sd_value,90)/100)) : Math.min(Math.round(sd_value), designBase); }
    // Cap: never below zero
    let designTotal = Math.max(0, designBase - special);

    // Quick Math uses post-special discount
    elQuickAlc.textContent = fmt(quickAlc);
    elQuickPkg.textContent = fmt(designTotal);
    const save = quickAlc - designTotal;
    elQuickSave.textContent = `${fmt(save)} (${quickAlc>0?Math.round(save*100/quickAlc):0}%)`;
    elQuickSave.className = 'num save ' + (save>0? 'good':'bad');

    elSub.textContent = fmt(subtotal);
    elDisc.textContent = `- ${fmt(discount)}`;
    elSpecial.textContent = `- ${fmt(special)}`;
    elDesign.textContent = fmt(designTotal);

    sdNoteView.style.display = sd_note ? 'block' : 'none';
    if(sd_note) sdNoteView.textContent = 'Note: ' + sd_note;

    return {subtotal, discount, special, designTotal};
  }

  function computeAddons(designTotal){
    let addons = 0; let rushFee = 0;
    document.querySelectorAll('#addons tbody tr').forEach(tr=>{
      const type = tr.dataset.addon;
      let line = 0;
      if(type==='boq'){
        const rooms = +tr.querySelector('input').value||0;
        const tier = Math.max(0, Math.min(rooms,3))*750 + Math.max(0, rooms-3)*650;
        line = tier;
        const extra = Math.max(0, rooms-3);
        elBoqLead.textContent = `${4+extra}–${5+extra}`;
      } else if(type==='rush'){
        const enabled = !rushToggle.disabled && rushToggle.checked;
        rushFee = enabled ? Math.round(designTotal * 0.20) : 0;
        line = rushFee;
      } else {
        const qty = +tr.querySelector('input').value||0;
        const unitNum = (type==='sitePack') ? 2500 : (type==='onSite'?450:(type==='online'?350:(type==='revision'?250:(type==='shopping'?500:600))));
        line = qty * unitNum;
      }
      tr.querySelector('.line').textContent = fmt(line);
      if(type!=='rush') addons += line;
    });
    document.getElementById('rushFee').textContent = fmt(rushFee);
    elRush.textContent = fmt(rushFee);
    elAddons.textContent = fmt(addons);
    return {addons, rushFee};
  }

  function computeAll(){
    setAutoQtyByPack();
    updatePillsAndBoxes();
    updateCapWarning();
    const {designTotal} = computeDesignLines();
    const {addons, rushFee} = computeAddons(designTotal);
    const grand = designTotal + addons + rushFee;
    elGrand.textContent = fmt(grand);
    footClient.textContent = byId('f_client').value || '—';
    footProject.textContent = byId('f_project').value || '—';
    buildTimeline();
  }

  // Timeline total-only
  function buildTimeline(){
    const tl = byId('timeline'); tl.innerHTML='';
    const pack = getCurrentPack();
    const rooms = +roomsInp.value||0;
    const d3qty = getFinalQty('d3');

    let totalDays = 0;

    if(pack.timeline==='p1'){
      let a=4,b=5,c=3,d=3;
      if(pack.rush && rushToggle.checked){ a=Math.ceil(a*0.75); b=Math.ceil(b*0.75); c=Math.ceil(c*0.75); d=Math.ceil(d*0.75); }
      totalDays = a+b+c+d;
    } else if(pack.timeline==='p2'){
      let a=5,b=8,c=5,d=4;
      if(pack.rush && rushToggle.checked){ a=Math.ceil(a*0.75); b=Math.ceil(b*0.75); c=Math.ceil(c*0.75); d=Math.ceil(d*0.75); }
      totalDays = a+b+c+d;
    } else if(pack.timeline==='p3'){
      totalDays = 7 + 12 + 7 + 6;
    } else if(pack.timeline==='p4'){
      totalDays = 10 + 18 + 9 + 8;
    } else {
      const phase1 = Math.max(3, Math.ceil(rooms/2)+3);
      const d3n = Math.max(1, d3qty);
      const phase2 = 3 * d3n;
      const phase3 = 5 + Math.max(0, rooms-3);
      const phase4 = 3;
      totalDays = phase1 + phase2 + phase3 + phase4;
    }

    const totalLine = document.createElement('div');
    totalLine.className='phase';
    totalLine.innerHTML = `<span><strong>Total</strong></span><span><strong>${totalDays} working days</strong></span>`;
    tl.appendChild(totalLine);

    const boqN = +document.getElementById('boqRooms').value||0;
    if(boqN>0){
      const extra = Math.max(0, boqN-3);
      const note = document.createElement('div'); note.className='note';
      note.textContent = `BOQ lead time: ${4+extra}–${5+extra} working days after design approval (+1 day per room above 3).`;
      tl.appendChild(note);
    }
  }

  function getFinalQty(key){
    const tr = document.querySelector(`#services tbody tr[data-service="${key}"]`);
    return +(tr?.querySelector('.final')?.textContent||0);
  }

  // Admin unlock / behavior
  function showAdmin(){
    if(lockedForClient) return;
    if(!adminPanel) return;
    const pin = prompt('Enter admin PIN to unlock special discount:');
    if(pin === ADMIN_PIN){ adminPanel.style.display='block'; syncAdminInputs(); }
    else alert('Wrong PIN.');
  }
  function syncAdminInputs(){
    if(!adminPanel) return;
    document.querySelectorAll('input[name="sd_mode"]').forEach(r=> r.checked = (r.value===sd_mode));
    sdValEl.value = String(sd_value||0);
    sdNoteEl.value = sd_note||'';
  }
  function applyAdmin(){
    const mode = document.querySelector('input[name="sd_mode"]:checked')?.value || 'pct';
    let val = Math.max(0, +sdValEl.value||0);
    sd_mode = mode; sd_value = val; sd_note = sdNoteEl.value.trim();
    computeAll();
  }
  function clearAdmin(){
    sd_value = 0; sd_note = ''; computeAll(); syncAdminInputs();
  }
  function copyClientLink(){
    // build link with query params, lock=1
    const base = window.location.origin + window.location.pathname;
    const params = new URLSearchParams();
    params.set('lock','1');
    if(sd_value>0) {
      if(sd_mode==='pct') params.set('sdpct', String(sd_value));
      else params.set('sdsar', String(sd_value));
    }
    if(sd_note) params.set('sdnote', sd_note);
    const url = base + '?' + params.toString();
    navigator.clipboard.writeText(url).then(()=> alert('Client link copied to clipboard:\n' + url));
  }

  // Events
  document.querySelectorAll('#services .allbox').forEach(box=>{
    box.addEventListener('change', e=>{
      const tr = e.target.closest('tr');
      const key = tr.dataset.service;
      if(pkgSel.value!=='Custom'){ e.target.checked=false; return; }
      if(e.target.checked) customAll.add(key); else customAll.delete(key);
      computeAll();
    });
  });

  document.querySelectorAll('#services tbody input.custom').forEach(inp=> inp.addEventListener('input', computeAll));
  document.querySelectorAll('#addons tbody input').forEach(inp=> inp.addEventListener('input', computeAll));
  document.getElementById('theme').addEventListener('change', e=>{ document.body.setAttribute('data-theme', e.target.value); });
  pkgSel.addEventListener('change', ()=>{ if(pkgSel.value!=='Custom') customAll = new Set(); computeAll(); });
  roomsInp.addEventListener('input', ()=>{ updateCapWarning(); buildTimeline(); });
  areaInp.addEventListener('input', updateCapWarning);

  // Print / PDF with validation
  document.getElementById('printBtn').addEventListener('click', ()=>{
    const required = ['f_client','f_id','f_phone','f_email','f_start','f_package'];
    for(const id of required){ const el = byId(id); if(!el || !el.value){ alert('Fill all required fields before printing.'); return; } }
    if(pkgSel.value==='Custom'){ const r=byId('f_rooms').value; if(!r || +r<=0){ alert('Enter Rooms for Custom package.'); return; } }
    const email = byId('f_email').value.trim();
    const phone = byId('f_phone').value.trim();
    const emailOk = /.+@.+\..+/.test(email);
    const phoneOk = /^(05\d{8}|\+?9665\d{8})$/.test(phone);
    if(!emailOk){ alert('Enter a valid email.'); return; }
    if(!phoneOk){ alert('Enter a valid Saudi phone number.'); return; }
    window.print();
  });

  // Clear custom qty
  document.getElementById('clearBtn').addEventListener('click', ()=>{
    pkgSel.value = 'Custom';
    document.querySelectorAll('#services tbody input.custom').forEach(i=> i.value=0);
    document.querySelectorAll('#services .allbox').forEach(b=> b.checked=false);
    customAll = new Set();
    document.querySelectorAll('#addons tbody input[type="number"]').forEach(i=> i.value=0);
    rushToggle.checked=false;
    computeAll();
  });

  // Unlock shortcuts
  if(hasAdminHash && !lockedForClient) setTimeout(showAdmin, 50);
  document.addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.altKey && (e.key==='a' || e.key==='A')) showAdmin(); });

  // Admin buttons
  if(adminPanel){ 
    sdApplyBtn.addEventListener('click', applyAdmin);
    sdClearBtn.addEventListener('click', clearAdmin);
    sdCopyBtn.addEventListener('click', copyClientLink);
  }

  // Hide admin for client when lock=1 (always)
  if(lockedForClient) adminPanel.style.display='none';

  // Initial render
  computeAll();
  // sync admin panel fields to current sd params
  if(!lockedForClient && hasAdminHash) syncAdminInputs();
})();
</script>
</body>
</html>
