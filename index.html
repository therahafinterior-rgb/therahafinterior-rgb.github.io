<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Interior Design — Proposal & Quote</title>
<style>
  :root{ --bg:#fffdf5; --card:#f5eee6; --ink:#1f2328; --muted:#5f4e52; --line:#eadede; --accent:#c6939f; --accent-ink:#ffffff; }
  [data-theme="classic"]{ --bg:#fffdf5; --card:#f5eee6; --ink:#1f2328; --muted:#5f4e52; --line:#eadede; --accent:#c6939f; --accent-ink:#ffffff; }
  [data-theme="sand"]{ --bg:#fffcf6; --card:#f3e8de; --ink:#2a2418; --muted:#6a5b3b; --line:#e8d8c7; --accent:#b79a83; --accent-ink:#ffffff; }
  [data-theme="sea"]{ --bg:#f0faf7; --card:#e6f2ef; --ink:#0f172a; --muted:#334155; --line:#cfe4df; --accent:#6fa1aa; --accent-ink:#ffffff; }

  html,body{ height:100%; }
  body{ font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--ink); margin:0; font-weight:500; font-size:13.4px; line-height:1.42; }
  *{ box-sizing:border-box; }

  header{ display:grid; grid-template-columns: auto 1fr auto; align-items:center; gap:12px; padding:10px 14px; border-bottom:1px solid var(--line); position:sticky; top:0; background:var(--bg); z-index:5; }
  .logo{ width:240px; height:72px; display:grid; place-items:center; }
  .logo img{ max-width:240px; max-height:72px; object-fit:contain; }
  .title{ text-align:center; font-weight:700; font-size:20px; letter-spacing:.2px; }
  .header-actions{ display:flex; gap:8px; align-items:center; }
  select, input[type="date"], input[type="text"], input[type="email"], input[type="number"]{ border:1px solid var(--line); background:#fff; color:var(--ink); border-radius:6px; padding:6px 8px; font-size:13px; height:32px; }
  button{ border:1px solid var(--line); background:var(--accent); color:var(--accent-ink); border-radius:8px; padding:6px 10px; font-weight:600; cursor:pointer; height:30px; }
  button.secondary{ background:#fff; color:var(--ink); }
  .btn-link{ border:none; background:transparent; color:var(--muted); text-decoration:underline; cursor:pointer; height:auto; padding:0; }

  .page{ padding:10px 12px; display:grid; grid-template-rows: auto 1fr; gap:10px; }

  .client{ background:var(--card); border:1px solid var(--line); border-radius:10px; padding:10px; }
  .client h3{ margin:0 0 8px 0; font-size:14px; }
  .grid-8{ display:grid; grid-template-columns: repeat(8, 1fr); gap:8px; }
  .grid-8 .field{ display:flex; flex-direction:column; gap:4px; }
  label{ font-size:11.5px; color:var(--muted); }
  .req{ color:#dc2626; }
  .warn{ color:#b45309; font-size:11px; margin-top:6px; display:none; }
  .note{ color:var(--muted); font-size:11px; margin-top:6px; }

  main.main{ display:grid; grid-template-columns: 1.4fr 1fr; gap:10px; }

  .card{ background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .card h3{ margin:0 0 8px 0; font-size:14px; }

  table{ width:100%; border-collapse:collapse; font-size:12.9px; }
  th, td{ border-bottom:1px solid var(--line); padding:6px 4px; text-align:right; }
  th{ font-size:11.5px; color:var(--muted); font-weight:600; }
  td:first-child, th:first-child{ text-align:left; }
  .qty{ width:56px; }
  .num{ font-variant-numeric: tabular-nums; }
  .muted{ color:var(--muted); font-size:11px; }
  .pill{ display:inline-block; padding:2px 6px; border-radius:999px; background:var(--card); border:1px solid var(--line); font-size:10.5px; color:var(--muted); cursor:pointer; }
  .pill.active{ background:var(--accent); color:var(--accent-ink); border-color:var(--accent); }

  .quick{ background:var(--card); border:1px dashed var(--line); border-radius:10px; padding:10px; display:grid; gap:6px; }
  .quick .line{ display:flex; justify-content:space-between; font-size:12.5px; }
  .save.good{ color:#047857; }
  .save.bad{ color:#b91c1c; }

  .totals{ background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; display:grid; gap:6px; margin-top:10px; }
  .totals .row{ display:flex; justify-content:space-between; font-size:12.6px; }
  .totals .row strong{ font-size:13.4px; }
  .totals .hr{ height:1px; background:var(--line); }

  .timeline .phase{ display:flex; justify-content:space-between; font-size:12.5px; padding:4px 0; border-bottom:1px dashed var(--line); }
  .timeline .phase:last-child{ border-bottom:0; }
  .timeline .dates{ font-size:11px; color:var(--muted); }

  .admin-badge{ background:#fee2e2; color:#991b1b; border:1px solid #fecaca; padding:2px 6px; border-radius:999px; font-size:11px; display:none; }
  .admin-only{ display:none; }

  footer{ display:flex; gap:14px; justify-content:space-between; align-items:center; font-size:11px; color:var(--muted); margin-top:6px; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  @page{ size: A4 landscape; margin: 10mm; }
  @media print{
    header{ position:static; }
    .page{ padding:0; }
    body{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    button, select, input{ -webkit-appearance:none; appearance:none; }
    .admin-only, .btn-link{ display:none !important; }
  }
</style>
</head>
<body data-theme="classic">
  <header>
    <div class="logo"><img alt="Logo" src="data:image/png;base64,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"></div>
    <div class="title">Interior Design — Proposal & Quote</div>
    <div class="header-actions">
      <span id="adminBadge" class="admin-badge">ADMIN</span>
      <button id="adminBtn" class="btn-link" title="Enter admin mode">Admin</button>
      <button id="adminExit" class="btn-link admin-only" title="Exit admin mode">Exit</button>
      <label for="theme" class="muted">Theme</label>
      <select id="theme" aria-label="Theme">
        <option value="classic">Classic</option>
        <option value="sand">Sand</option>
        <option value="sea">Sea</option>
      </select>
      <button id="printBtn" title="Print / Save PDF">Print / PDF</button>
      <button id="clearBtn" class="secondary" title="Reset custom & switch to Custom">Clear custom qty</button>
    </div>
  </header>

  <div class="page">
    <section class="client card">
      <h3>Client & Project</h3>
      <div class="grid-8">
        <div class="field"><label>Client<span class="req">*</span></label><input id="f_client" type="text" required></div>
        <div class="field"><label>National ID<span class="req">*</span></label><input id="f_id" type="text" required></div>
        <div class="field"><label>Phone (Saudi)<span class="req">*</span></label><input id="f_phone" type="text" inputmode="numeric" pattern="^(05\d{8}|\+?9665\d{8})$" title="Saudi: 05XXXXXXXX or +9665XXXXXXXX" required></div>
        <div class="field"><label>Email<span class="req">*</span></label><input id="f_email" type="email" required></div>
        <div class="field"><label>Project</label><input id="f_project" type="text"></div>
        <div class="field"><label>Start (date)<span class="req">*</span></label><input id="f_start" type="date" required></div>
        <div class="field"><label>Package<span class="req">*</span></label>
          <select id="f_package">
            <option>Custom</option>
            <option>Package 1</option>
            <option>Package 2</option>
            <option>Package 3</option>
            <option>Package 4</option>
          </select>
        </div>
        <div class="field"><label>Rooms<span class="req" id="roomsStar">*</span></label><input id="f_rooms" type="number" min="0" value="0"></div>
        <div class="field"><label>Area m²</label><input id="f_area" type="number" min="0" value="0"></div>
      </div>
      <div id="capWarn" class="warn">Heads‑up: Selected package coverage exceeded. Extra rooms/area will be priced A la carte.</div>
      <div class="note">We will rely on notes and approvals from this phone/email only. Timeline starts after payment/data handover. <strong>Revision days and public holidays are excluded</strong>. <strong>Quote is valid for 14 days.</strong> This invoice becomes binding upon both parties' signatures.</div>
    </section>

    <main class="main">
      <section class="card">
        <h3>Design Services</h3>
        <table id="services">
          <thead>
            <tr>
              <th>Service</th>
              <th>Unit SAR</th>
              <th>Auto Qty</th>
              <th>Custom Qty</th>
              <th>ALL plan</th>
              <th>Final Qty</th>
              <th>Line Total</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="customAllSummary" class="note" style="display:none"></div>

        <h3 style="margin-top:10px;">Add‑ons</h3>
        <table id="addons">
          <thead>
            <tr>
              <th>Add‑on</th>
              <th>Unit SAR</th>
              <th>Qty</th>
              <th>Line Total</th>
            </tr>
          </thead>
          <tbody>
            <tr data-addon="siteVisit"><td>Site supervision — per visit</td><td class="num">600</td><td><input class="qty" type="number" min="0" value="0"></td><td class="num line">0</td></tr>
            <tr data-addon="sitePack"><td>Site supervision — 5‑visit pack</td><td class="num">2500</td><td><input class="qty" type="number" min="0" value="0"></td><td class="num line">0</td></tr>
            <tr data-addon="onSite"><td>On‑site consultation (session)</td><td class="num">450</td><td><input class="qty" type="number" min="0" value="0"></td><td class="num line">0</td></tr>
            <tr data-addon="online"><td>Online consultation (session)</td><td class="num">350</td><td><input class="qty" type="number" min="0" value="0"></td><td class="num line">0</td></tr>
            <tr data-addon="boq"><td>BOQ — per room <span class="muted">(1–3 rooms @750, 4+ @650)</span></td><td class="num">tiered</td><td><input id="boqRooms" class="qty" type="number" min="0" value="0"></td><td class="num line">0</td></tr>
            <tr data-addon="revision"><td>Extra revision (round)</td><td class="num">250</td><td><input class="qty" type="number" min="0" value="0"></td><td class="num line">0</td></tr>
            <tr data-addon="shopping"><td>Shopping day / sourcing (per day)</td><td class="num">500</td><td><input class="qty" type="number" min="0" value="0"></td><td class="num line">0</td></tr>
            <tr data-addon="rush"><td>Rush (P1–P2 only) <span class="muted">+20% of design total</span></td><td class="num">—</td><td><input id="rushToggle" type="checkbox"></td><td class="num line" id="rushFee">0</td></tr>
          </tbody>
        </table>
      </section>

      <section class="card">
        <h3>Quick Math</h3>
        <div class="quick" id="quick">
          <div class="line"><span>A la carte total (no discount)</span><strong class="num" id="qm_alc">0</strong></div>
          <div class="line"><span>Package price</span><strong class="num" id="qm_pkg">0</strong></div>
          <div class="line"><span>You save</span><strong class="num save" id="qm_save">0</strong></div>
        </div>

        <div class="admin-only totals" id="adminPanel">
          <h3>Admin — Extra Discount</h3>
          <div class="row" style="gap:8px; align-items:center;">
            <label style="min-width:90px;">Discount</label>
            <select id="admType"><option value="pct">% Percent</option><option value="fix">SAR Fixed</option></select>
            <input id="admValue" type="number" min="0" value="0" style="width:90px;">
            <button id="admClear" class="secondary" style="margin-left:auto;">Clear</button>
          </div>
          <div class="note">Applied on top of package discount. Affects design total only (before Rush & Add-ons).</div>
        </div>

        <div class="totals" id="totalsBox">
          <div class="row"><span>Design subtotal</span><strong class="num" id="t_sub">0</strong></div>
          <div class="row"><span>Package discount</span><strong class="num" id="t_disc">0</strong></div>
          <div class="row admin-only" id="row_adm"><span>Admin discount</span><strong class="num" id="t_adm">0</strong></div>
          <div class="hr"></div>
          <div class="row"><span>Design total</span><strong class="num" id="t_design">0</strong></div>
          <div class="row"><span>Rush fee</span><strong class="num" id="t_rush">0</strong></div>
          <div class="row"><span>Add-ons subtotal</span><strong class="num" id="t_addons">0</strong></div>
          <div class="hr"></div>
          <div class="row"><span><strong>Grand total</strong></span><strong class="num" id="t_grand">0</strong></div>
        </div>

        <h3 style="margin-top:10px;">Timeline</h3>
        <div class="muted" style="margin:4px 0 8px; display:flex; gap:8px; align-items:center; flex-wrap: wrap;">
          <span>Timeline view:</span>
          <select id="timelineView" aria-label="Timeline View">
            <option value="detailed" selected>Detailed phases</option>
            <option value="total">Total only</option>
          </select>
          <label style="display:flex; gap:6px; align-items:center; margin-left:12px;">
            <input id="showDates" type="checkbox"> <span>Show calendar dates</span>
          </label>
          <label style="display:flex; gap:6px; align-items:center;">
            Holidays (YYYY-MM-DD, comma; ranges OK): <input id="holidays" type="text" placeholder="2025-06-15–2025-06-18, 2025-09-23" style="width:260px;">
          </label>
        </div>
        <div class="note" id="pkgOverview">Package durations (working days): P1 ≈ 16 (Rush ≈ 13) • P2 ≈ 21 (Rush ≈ 17) • P3 ≈ 30 • P4 ≈ 43.</div>
        <div class="timeline" id="timeline"></div>
        <div class="note" style="margin-top:6px;">Shop drawings exclude carpentry scope. BOQ time (<span class="mono" id="boqLead">4–5</span> working days) is added separately to the work schedule.</div>
        <div class="note" style="margin-top:4px;"><strong>Important:</strong> All durations are in working days (Sun–Thu), exclude Fri/Sat, <strong>exclude public holidays</strong>, and exclude revision rounds. Dates are indicative and may shift with approvals or scope changes.</div>
      </section>
    </main>

    <footer>
      <div>Prepared by: <span class="mono" id="footClient">—</span> | Project: <span class="mono" id="footProject">—</span></div>
      <div class="muted">Generated by: One‑Page Quote Calculator — A4 Landscape — MASTER v1.6d (Admin Discount + ALL plan ×1.5)</div>
    </footer>
  </div>

<script>
(function(){
  // ===== Admin PIN (client-side, cosmetic security) =====
  const isAdminRoute = location.hash.includes('admin') || new URLSearchParams(location.search).get('admin')==='1';
  const ADMIN_HASH = "e38fa75ec230eecbb53b3e2809eb8e99108a596c65bdff543bc904cf11a5184d";
  const LS_MODE = "idq_admin_mode_v1";
  const LS_PIN  = "idq_admin_pin_set_v1"; // not used to store plaintext, only a flag

  async function sha256(txt){
    const enc = new TextEncoder().encode(txt);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  async function enterAdminFlow(){
    const pin = prompt("Enter admin PIN:");
    if(!pin) return;
    const h = await sha256(pin);
    if(h === ADMIN_HASH || localStorage.getItem(LS_PIN) === h){ 
      localStorage.setItem(LS_MODE,'1'); adminOn(); alert('Admin mode enabled.');
    } else { alert('Wrong PIN'); }
  }
  function adminOn(){
    document.getElementById('adminBadge').style.display='inline-block';
    document.querySelectorAll('.admin-only').forEach(el=> el.style.display='block');
  }
  function adminOff(){
    localStorage.removeItem(LS_MODE);
    document.getElementById('adminBadge').style.display='none';
    document.querySelectorAll('.admin-only').forEach(el=> el.style.display='none');
    document.getElementById('admValue').value = 0;
    // Clean #admin from URL
    if(location.hash.includes('admin')){ try{ history.replaceState('', document.title, location.pathname + location.search); }catch(e){} }
    computeAll();
  }

  // ===== Core helpers =====
  const fmt = n => new Intl.NumberFormat('en-US',{maximumFractionDigits:0}).format(Math.round(n||0));
  const byId = id => document.getElementById(id);

  const SERVICES = [
    {key:'d3', name:'3D (per space)', unit:1605},
    {key:'mood', name:'Mood board (per space)', unit:300},
    {key:'furniture', name:'Furniture plan', unit:840},
    {key:'rc', name:'RC plans', unit:600},
    {key:'flooring', name:'Flooring plan', unit:420},
    {key:'lighting', name:'Lighting plan', unit:840},
    {key:'materials', name:'Material selections', unit:600},
    {key:'execution', name:'Shop drawings (no carpentry)', unit:1100},
    {key:'elev', name:'Room elevations (per room)', unit:900}
  ];
  const ELIGIBLE = new Set(['furniture','rc','flooring','lighting']);

  const PACKS = {
    'Custom': { label:'Custom', disc:0, capRooms:Infinity, capArea:Infinity, rush:false,
      auto:{ d3:0, mood:0, furniture:0, rc:0, flooring:0, lighting:0, materials:0, execution:0, elev:0 },
      allPlan: new Set(), timeline:'custom' },
    'Package 1': { label:'Package 1', disc:0.15, capRooms:3, capArea:90, rush:true,
      auto:{ d3:0, mood:2, furniture:1, rc:1, flooring:1, lighting:1, materials:1, execution:1, elev:2 },
      allPlan: new Set(), timeline:'p1' },
    'Package 2': { label:'Package 2', disc:0.12, capRooms:4, capArea:120, rush:true,
      auto:{ d3:2, mood:0, furniture:1, rc:1, flooring:1, lighting:1, materials:1, execution:1, elev:2 },
      allPlan: new Set(), timeline:'p2' },
    'Package 3': { label:'Package 3', disc:0.14, capRooms:4, capArea:180, rush:false,
      auto:{ d3:3, mood:3, furniture:1, rc:1, flooring:1, lighting:1, materials:1, execution:1, elev:3 },
      allPlan: new Set(['furniture','flooring']), timeline:'p3' },
    'Package 4': { label:'Package 4', disc:0.16, capRooms:6, capArea:240, rush:false,
      auto:{ d3:5, mood:3, furniture:1, rc:1, flooring:1, lighting:1, materials:1, execution:1, elev:5 },
      allPlan: new Set(['furniture','rc','flooring','lighting']), timeline:'p4' }
  };

  // Build rows
  const servicesTbody = document.querySelector('#services tbody');
  SERVICES.forEach(s => {
    const tr = document.createElement('tr');
    tr.dataset.service = s.key;
    const pill = ELIGIBLE.has(s.key) ? '<span class="pill allpill" data-key="'+s.key+'">ALL plan eligible</span>' : '';
    const allCtl = ELIGIBLE.has(s.key) ? '<input type="checkbox" class="allbox" disabled>' : '—';
    tr.innerHTML = '<td>'+s.name+' '+pill+'</td>' +
                   '<td class="num unit">'+fmt(s.unit)+'</td>' +
                   '<td class="num auto">0</td>' +
                   '<td><input class="qty custom" type="number" min="0" value="0"></td>' +
                   '<td class="allcol" style="text-align:center;">'+allCtl+'</td>' +
                   '<td class="num final">0</td>' +
                   '<td class="num line">0</td>';
    servicesTbody.appendChild(tr);
  });

  // DOM refs
  const pkgSel = byId('f_package');
  const roomsInp = byId('f_rooms');
  const areaInp = byId('f_area');
  const rushToggle = byId('rushToggle');
  const boqRooms = byId('boqRooms');
  const viewSel = byId('timelineView');
  const showDates = byId('showDates');
  const holidaysInp = byId('holidays');

  const elSub = byId('t_sub');
  const elDisc = byId('t_disc');
  const elAdm = byId('t_adm');
  const elDesign = byId('t_design');
  const elRush = byId('t_rush');
  const elAddons = byId('t_addons');
  const elGrand = byId('t_grand');

  const elQuickAlc = byId('qm_alc');
  const elQuickPkg = byId('qm_pkg');
  const elQuickSave = byId('qm_save');
  const elCapWarn = byId('capWarn');
  const elBoqLead = byId('boqLead');
  const footClient = byId('footClient');
  const footProject = byId('footProject');
  const customAllSummary = byId('customAllSummary');

  // Admin UI refs
  const adminBtn = byId('adminBtn');
  const adminPanel = byId('adminPanel');
  const admType = byId('admType');
  const admValue = byId('admValue');
  const admClear = byId('admClear');

  let customAll = new Set();

  // Admin events
  adminBtn.addEventListener('click', async()=>{ await enterAdminFlow(); });
  admClear.addEventListener('click', ()=>{ admValue.value=0; computeAll(); });
  const adminExit = document.getElementById('adminExit'); if(adminExit){ adminExit.addEventListener('click', ()=> adminOff()); }
  admType.addEventListener('change', computeAll);
  admValue.addEventListener('input', computeAll);

  // Admin entry only when on admin route; never auto-show for normal links
  if(isAdminRoute){ enterAdminFlow(); if(localStorage.getItem(LS_MODE)==='1'){ adminOn(); } }
  // Hide Admin button for non-admin route
  (function(){ const b=document.getElementById('adminBtn'); if(b) b.style.display = isAdminRoute? 'inline':'none'; })();

  function getCurrentPack(){ return PACKS[pkgSel.value] || PACKS['Custom']; }
  function packIsAll(key){ const pack = getCurrentPack(); return pack.allPlan.has(key); }
  function customIsAll(key){ return customAll.has(key); }

  function updatePillsAndBoxes(){
    const isCustom = pkgSel.value==='Custom';
    document.querySelectorAll('#services tbody tr').forEach(tr=>{
      const key = tr.dataset.service;
      const pill = tr.querySelector('.allpill');
      const box = tr.querySelector('.allbox');
      if(pill){
        const active = isCustom ? customIsAll(key) : packIsAll(key);
        pill.textContent = active ? 'ALL plan (active)' : 'ALL plan eligible';
        pill.classList.toggle('active', active);
      }
      if(box){ box.disabled = !isCustom; box.checked = isCustom ? customIsAll(key) : false; }
    });
    if(pkgSel.value==='Custom'){
      const names = Array.from(customAll).map(k=> {
        const s = SERVICES.find(x=>x.key===k);
        return s ? s.name.split(' ')[0] : null;
      }).filter(Boolean);
      if(names.length){ customAllSummary.style.display='block'; customAllSummary.textContent = 'ALL plan active (Custom): ' + names.join(', '); }
      else { customAllSummary.style.display='none'; customAllSummary.textContent=''; }
    } else { customAllSummary.style.display='none'; customAllSummary.textContent=''; }
  }

  function updateCapWarning(){
    const pack = getCurrentPack();
    const rooms = +roomsInp.value||0; const area = +areaInp.value||0;
    const exceeded = (rooms>pack.capRooms) || (area>pack.capArea);
    elCapWarn.style.display = exceeded && pkgSel.value!=='Custom' ? 'block':'none';
  }

  function setAutoQtyByPack(){
    const pack = getCurrentPack();
    document.querySelectorAll('#services tbody tr').forEach(tr=>{
      const key = tr.dataset.service;
      const autoQty = pack.auto[key] ?? 0;
      tr.querySelector('.auto').textContent = autoQty;
      const customField = tr.querySelector('input.custom');
      const finalCell = tr.querySelector('.final');
      if(pkgSel.value==='Custom'){
        customField.removeAttribute('disabled');
        finalCell.textContent = +customField.value||0;
      }else{
        customField.value = 0;
        customField.setAttribute('disabled','disabled');
        finalCell.textContent = autoQty;
      }
    });
    const p = pkgSel.value;
    if(PACKS[p].rush && rushToggle){ rushToggle.removeAttribute('disabled'); }
    else if(rushToggle){ rushToggle.checked=false; rushToggle.setAttribute('disabled','disabled'); }

    const roomsStar = document.getElementById('roomsStar');
    if(p === 'Custom'){ roomsInp.setAttribute('required','required'); if(roomsStar) roomsStar.style.display='inline'; }
    else { roomsInp.removeAttribute('required'); if(roomsStar) roomsStar.style.display='none'; }
  }

  function computeDesignLines(){
    let subtotal = 0;
    let quickAlc = 0;
    const isCustom = pkgSel.value==='Custom';
    const pack = getCurrentPack();

    document.querySelectorAll('#services tbody tr').forEach(tr=>{
      const key = tr.dataset.service;
      const svc = SERVICES.find(s=>s.key===key);
      const unitBase = svc.unit;
      const autoQty = +(tr.querySelector('.auto').textContent||0);
      const customQty = +(tr.querySelector('input.custom').value||0);
      const finalQty = isCustom ? customQty : autoQty;
      tr.querySelector('.final').textContent = finalQty;

      const activeAll = ELIGIBLE.has(key) && ( isCustom ? customAll.has(key) : packIsAll(key) );
      const unitAdj = unitBase * (activeAll ? 1.5 : 1);
      tr.querySelector('.unit').textContent = fmt(unitAdj);
      const line = unitAdj * finalQty;
      tr.querySelector('.line').textContent = fmt(line);
      subtotal += line; quickAlc += line;
    });

    const packDisc = Math.round(subtotal * pack.disc);
    let afterPack = subtotal - packDisc;
    if(pkgSel.value==='Package 1' && afterPack < 6500){ afterPack = 6500; }

    // Admin discount
    let adminDisc = 0;
    if(localStorage.getItem(LS_MODE)==='1'){ 
      const v = +admValue.value||0; 
      if(v>0){ 
        if(admType.value==='pct') adminDisc = Math.round(afterPack * (Math.min(v,100)/100));
        else adminDisc = Math.min(v, afterPack);
      }
    }
    const designTotal = Math.max(0, afterPack - adminDisc);

    elSub.textContent = fmt(subtotal);
    elDisc.textContent = '- '+fmt(packDisc);
    if(localStorage.getItem(LS_MODE)==='1'){ document.getElementById('row_adm').style.display='flex'; elAdm.textContent = '- '+fmt(adminDisc); }
    else { document.getElementById('row_adm').style.display='none'; elAdm.textContent = '0'; }

    elQuickAlc.textContent = fmt(quickAlc);
    elQuickPkg.textContent = fmt(designTotal);
    const save = quickAlc - designTotal;
    elQuickSave.textContent = fmt(save)+' ('+(quickAlc>0?Math.round(save*100/quickAlc):0)+'%)';
    elQuickSave.className = 'num save ' + (save>0? 'good':'bad');

    elDesign.textContent = fmt(designTotal);

    return {subtotal, packDisc, adminDisc, designTotal};
  }

  function computeAddons(designTotal){
    let addons = 0; let rushFee = 0;
    document.querySelectorAll('#addons tbody tr').forEach(tr=>{
      const type = tr.dataset.addon;
      let line = 0;
      if(type==='boq'){ 
        const rooms = +tr.querySelector('input').value||0;
        const tier = Math.max(0, Math.min(rooms,3))*750 + Math.max(0, rooms-3)*650;
        line = tier;
        const extra = Math.max(0, rooms-3);
        elBoqLead.textContent = (4+extra)+'–'+(5+extra);
      } else if(type==='rush'){ 
        const enabled = rushToggle && !rushToggle.disabled && rushToggle.checked;
        rushFee = enabled ? Math.round(designTotal * 0.20) : 0;
        line = rushFee;
      } else {
        const qty = +tr.querySelector('input').value||0;
        const unitNum = (type==='sitePack') ? 2500 : (type==='onSite'?450:(type==='online'?350:(type==='revision'?250:(type==='shopping'?500:600))));
        line = qty * unitNum;
      }
      tr.querySelector('.line').textContent = fmt(line);
      if(type!=='rush') addons += line;
    });
    elRush.textContent = fmt(rushFee);
    elAddons.textContent = fmt(addons);
    return {addons, rushFee};
  }

  function computeAll(){
    setAutoQtyByPack();
    updatePillsAndBoxes();
    updateCapWarning();
    const {designTotal} = computeDesignLines();
    const {addons, rushFee} = computeAddons(designTotal);
    const grand = designTotal + addons + rushFee;
    elGrand.textContent = fmt(grand);
    footClient.textContent = byId('f_client').value || '—';
    footProject.textContent = byId('f_project').value || '—';
    buildTimeline();
  }

  // Mood board days: 2 per room
  function phase1MoodDays(packKey, rooms){ const d={ p1:4, p2:5, p3:7, p4:10 }; if(rooms>0) return rooms*2; return d[packKey] || 3; }

  // Dates helpers
  
function parseHolidaySet(){
  const str = (holidaysInp.value||'').trim();
  const set = new Set();
  if(!str) return set;
  const parts = str.split(',').map(s=>s.trim()).filter(Boolean);
  for(const p of parts){
    const m = p.match(/^(\d{4}-\d{2}-\d{2})\s*(?:\-|–|—|to|TO|To|\.\.)\s*(\d{4}-\d{2}-\d{2})$/);
    if(m){
      const a0 = new Date(m[1]+'T00:00:00');
      const b0 = new Date(m[2]+'T00:00:00');
      if(!isNaN(a0) && !isNaN(b0)){
        let a=a0, b=b0;
        if(a.getTime()>b.getTime()){ const t=a; a=b; b=t; }
        for(let d=new Date(a.getTime()); d.getTime()<=b.getTime(); d.setDate(d.getDate()+1)){
          set.add(new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime());
        }
      }
    }else{
      const d = new Date(p+'T00:00:00');
      if(!isNaN(d)){
        set.add(new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime());
      }
    }
  }
  return set;
}

  function isWorkingDay(d,hset){ const day=d.getDay(); const ts=new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime(); return (day!==5 && day!==6) && !hset.has(ts); }
  function addWorkingDays(startDate, days, hset){ if(!startDate||isNaN(startDate)) return null; let d=new Date(startDate.getTime()); let r=days; while(r>0){ if(isWorkingDay(d,hset)) r--; if(r===0) break; d.setDate(d.getDate()+1); } return {end:d}; }
  function nextWorkingDay(d,hset){ const n=new Date(d.getTime()); n.setDate(n.getDate()+1); while(!isWorkingDay(n,hset)){ n.setDate(n.getDate()+1); } return n; }
  function fmtDate(d){ return d.toLocaleDateString('en-GB',{year:'numeric', month:'short', day:'2-digit'}).replace(',', ''); }

  function getFinalQty(key){ const tr=document.querySelector('#services tbody tr[data-service="'+key+'"]'); if(!tr) return 0; const fc=tr.querySelector('.final'); return +(fc?fc.textContent:0); }

  function buildTimeline(){
    const tl = byId('timeline'); tl.innerHTML='';
    const pack = getCurrentPack();
    const rooms = +roomsInp.value||0;
    const d3qty = getFinalQty('d3');
    const mode = (viewSel && viewSel.value) || 'detailed';
    const wantDates = showDates && showDates.checked;
    const startStr = (byId('f_start').value||'').trim();
    const startDate = startStr ? new Date(startStr + 'T00:00:00') : null;
    const hset = parseHolidaySet();

    let phases = [];
    if(pack.timeline==='p1'){
      let a = phase1MoodDays('p1', rooms);
      let b = 5, c = 4, d = 3;
      if(pack.rush && rushToggle && rushToggle.checked){ a=Math.ceil(a*0.75); b=Math.ceil(b*0.75); c=Math.ceil(c*0.75); d=Math.ceil(d*0.75); }
      phases = [
        ['Mood + preliminary furniture', a],
        ['Develop plans + early elevations', b],
        ['Shop drawings + materials', c],
        ['Reviews + final files', d]
      ];
    } else if(pack.timeline==='p2'){
      let a = phase1MoodDays('p2', rooms);
      let b = 6, c = 6, d = 4;
      if(pack.rush && rushToggle && rushToggle.checked){ a=Math.ceil(a*0.75); b=Math.ceil(b*0.75); c=Math.ceil(c*0.75); d=Math.ceil(d*0.75); }
      phases = [
        ['Mood + preliminary furniture', a],
        ['3D (2 spaces)', b],
        ['Shop drawings + materials + elevations', c],
        ['Reviews + handover', d]
      ];
    } else if(pack.timeline==='p3'){
      const a = phase1MoodDays('p3', rooms);
      phases = [
        ['Mood + preliminary furniture (some ALL)', a],
        ['3D (3 spaces)', 9],
        ['Shop drawings + materials + elevations', 8],
        ['Reviews + handover', 6]
      ];
    } else if(pack.timeline==='p4'){
      const a = phase1MoodDays('p4', rooms);
      phases = [
        ['Mood + preliminary furniture (ALL)', a],
        ['3D (5 spaces)', 15],
        ['Shop drawings + materials + elevations', 10],
        ['Reviews + handover', 8]
      ];
    } else {
      const base1 = Math.max(3, Math.ceil((rooms||1)/2)+3);
      const a = Math.max(base1, (rooms||1)*2);
      const d3n = Math.max(1, d3qty);
      const b = 3 * d3n;
      const c = 5 + Math.max(0, rooms-3);
      const d = 3;
      phases = [
        ['Phase 1 — Mood + preliminary furniture', a],
        ['Phase 2 — 3D', b],
        ['Phase 3 — Shop drawings + materials', c],
        ['Phase 4 — Reviews', d]
      ];
    }

    const totalDays = phases.reduce((acc, [,d])=> acc+d, 0);

    let cursor = startDate && !isNaN(startDate) ? new Date(startDate.getTime()) : null;
    if(mode==='detailed'){
      phases.forEach(([name, days])=>{
        let rangeStr = '';
        if(wantDates && cursor){ while(!isWorkingDay(cursor,hset)) cursor.setDate(cursor.getDate()+1);
          const res = addWorkingDays(cursor, days, hset); const end = res.end;
          rangeStr = fmtDate(cursor)+' – '+fmtDate(end); cursor = nextWorkingDay(end,hset); }
        const row = document.createElement('div'); row.className='phase';
        row.innerHTML = '<span>'+name+' '+(rangeStr?'<span class="dates">('+rangeStr+')</span>':'')+'</span><span><strong>'+days+' wd</strong></span>';
        tl.appendChild(row);
      });
      const tot = document.createElement('div'); tot.className='phase';
      let totalEndStr='';
      if(wantDates && startDate){ let cur=new Date(startDate.getTime()); while(!isWorkingDay(cur,hset)) cur.setDate(cur.getDate()+1);
        const res=addWorkingDays(cur,totalDays,hset); totalEndStr=' ('+fmtDate(cur)+' – '+fmtDate(res.end)+')'; }
      tot.innerHTML = '<span><strong>Total</strong>'+totalEndStr+'</span><span><strong>'+totalDays+' working days</strong></span>';
      tl.appendChild(tot);
    } else {
      const row = document.createElement('div'); row.className='phase';
      let rangeStr=''; if(wantDates && startDate){ let cur=new Date(startDate.getTime()); while(!isWorkingDay(cur,hset)) cur.setDate(cur.getDate()+1);
        const res=addWorkingDays(cur,totalDays,hset); rangeStr=' ('+fmtDate(cur)+' – '+fmtDate(res.end)+')'; }
      row.innerHTML = '<span><strong>Total</strong>'+rangeStr+'</span><span><strong>'+totalDays+' working days</strong></span>';
      tl.appendChild(row);
    }

    const boqN = +byId('boqRooms').value||0;
    if(boqN>0){ const extra=Math.max(0,boqN-3); const dMin=4+extra, dMax=5+extra;
      const note=document.createElement('div'); note.className='note';
      if(wantDates && startDate){ let cur=new Date(startDate.getTime()); while(!isWorkingDay(cur,hset)) cur.setDate(cur.getDate()+1);
        const res=addWorkingDays(cur,totalDays,hset); let boqStart=nextWorkingDay(res.end,hset);
        const resMax=addWorkingDays(boqStart,dMax,hset).end;
        note.textContent='BOQ lead time: '+dMin+'–'+dMax+' working days after design approval — approx. '+fmtDate(boqStart)+' – '+fmtDate(resMax)+'.'; }
      else { note.textContent='BOQ lead time: '+dMin+'–'+dMax+' working days after design approval (+1 day per room above 3).'; }
      tl.appendChild(note);
    }
  }

  // Wire inputs
  document.querySelectorAll('#services tbody input.custom').forEach(inp=> inp.addEventListener('input', computeAll));
  document.querySelectorAll('#addons tbody input').forEach(inp=> inp.addEventListener('input', computeAll));
  document.getElementById('theme').addEventListener('change', e=>{ document.body.setAttribute('data-theme', e.target.value); });
  pkgSel.addEventListener('change', ()=> computeAll());
  roomsInp.addEventListener('input', ()=>{ updateCapWarning(); buildTimeline(); });
  areaInp.addEventListener('input', updateCapWarning);
  viewSel.addEventListener('change', buildTimeline);
  showDates.addEventListener('change', buildTimeline);
  holidaysInp.addEventListener('input', buildTimeline);
  byId('f_start').addEventListener('change', buildTimeline);

  // ALL plan toggles (Custom only)
  function wireAllToggles(){
    document.querySelectorAll('#services tbody .allbox').forEach(box=>{ 
      box.addEventListener('change', e=>{ const tr=e.target.closest('tr'); const key=tr.dataset.service; if(pkgSel.value!=='Custom') return; if(e.target.checked) customAll.add(key); else customAll.delete(key); computeAll(); });
    });
    document.querySelectorAll('#services tbody .allpill').forEach(p=>{ 
      p.addEventListener('click', e=>{ const key=e.target.getAttribute('data-key'); if(pkgSel.value!=='Custom') return; if(customAll.has(key)) customAll.delete(key); else customAll.add(key); computeAll(); });
    });
  }
  wireAllToggles();

  // Print guard
  document.getElementById('printBtn').addEventListener('click', ()=>{
    const required = ['f_client','f_id','f_phone','f_email','f_start','f_package'];
    for(const id of required){ const el = byId(id); if(!el || !el.value){ alert('Fill all required fields before printing.'); return; } }
    if(pkgSel.value==='Custom'){ const r=byId('f_rooms').value; if(!r || +r<=0){ alert('Enter Rooms for Custom package.'); return; } }
    const email = byId('f_email').value.trim();
    const phone = byId('f_phone').value.trim();
    const emailOk = /.+@.+\..+/.test(email);
    const phoneOk = /^(05\d{8}|\+?9665\d{8})$/.test(phone);
    if(!emailOk){ alert('Enter a valid email.'); return; }
    if(!phoneOk){ alert('Enter a valid Saudi phone number.'); return; }
    window.print();
  });

  document.getElementById('clearBtn').addEventListener('click', ()=>{
    byId('f_package').value = 'Custom';
    document.querySelectorAll('#services tbody input.custom').forEach(i=> i.value=0);
    document.querySelectorAll('#addons tbody input[type="number"]').forEach(i=> i.value=0);
    const r=document.getElementById('rushToggle'); if(r) r.checked=false;
    customAll = new Set(); updatePillsAndBoxes(); computeAll();
  });

  computeAll();
})();
</script>
</body>
</html>
